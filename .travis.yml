sudo: required
dist: trusty
addons:
  apt:
    sources:
    - chef-stable-trusty
    packages:
    - chefdk
install: echo "skip bundle install"
branches:
  only:
  - master
services: docker
env:
  matrix:
  - INSTANCE=default-centos-66
  global:
  - secure: Gyor7zZSoOfYRpvRd8aiUCYbTVfmqbsvJcba2x/lK095YY3YvVMX272TcicrrSSMTECBEYQLKYWnNYI/dEucDc7M7+eGuQjK/6+oiajwEAcpfMydh0X/IiCd/0H1dyXrZ0awpy3g0z95/vNwzGekFkdkYMBTue6UQ5ev4ntKO/EXPlTJyYN5XueqbZTKC6QODQVHsoiWHJV/9hwXgMmEXCgKkkTsFoTjosPSQFJO/LKJAppoOZBMtaQPagtQjjRxAHW3xT0FeFS6ibjCmvhvMinrirSJf7OWZMmWyzj1V17cUfjX74WISy0ntKZ/kvpIzM+tzRbLxaGJ9uXyhQFSfFIAVkzAkb9Qk8LM6+fb4v2Qer9bDdhIQIwYXX+8FPdLemrUM9o8A1HuniEfIU4ITl4i0YL8/EqLVQ+hiqrLuaj6980/2rs+glN1bPzdl8ptIIS/8QD8JbcUxMfKPUUk6bvGEBudEO+5oFtmhNqyBHk0Bay4OyJ3yAH0wdwR9+mIcO7STzDmSlsD4pj68Up7J+3age56sKZOAK1Jt+7XU8mhs2FwvSAKNfM5v5+E/ikD2STvSHBsFLEzWTulAi9/OhRCTULO/k7j0ULFp3W1Vj/qeUMfNthqmgRJq1OmqC+43nrf+yLz7ZiauUh7QmVNzIG1zE4Jt0XW0XfJCNtTcgY=
  - secure: ey0NZRC+SfMHbs/jRfOk9Tczg+Ivj9Xlm3k0kD2qlIZ9K1v6kHNnxDIcvLeUw+g722r3UQW1YLg4wl2CkhGAmaMYFcOkIvV/mzfuA8l8s+JNzxdrtFmuLLmGlpKRMBINv2v5V5CscQOF7wwx22bNsBxHl3oR9WMRvjwHPb7G8zrKvTBu46Pn5ckBKXWjrADCEeQwIb5l4BZU7xLwEDXY2TxvY+C10YXyb4IMvkolqCXY288zjXx+4INhDudILQH28s6IYpXaoVnaPlAqadZtLEqnrBA0EbSi0sl/gMdgM4wbGImmMoixAPyqvotluFcomVfceu5KTS9lgInyV/wcL+V2j6IUp1VGrLB+aRlQonWXIkOi0poiSqWdgfUvUv8kMWLafJ+/R9bAAX7epOBtwUJKdVc7xuhijuXBIuiBiNM0yiSgFk+2JuJRtpn+kQkSu3bKvHLjKE2YVUeDhz4S6ZSSgq5iN8cy/BJH9QYQnIgT5MtJ6IuUt39S+jSFcOx5aT24i1I7WNUWFvqwp62Zs7WYpXbMFFxne8oxlfbwheGWefhs3LKcxtmMwPtslojZKMfVjnWszt7ocjmVYzmCNslUKlHv8qUz4h818k6BanZtcafTXBJcXWv5oUsUzJqmbV1OmC8wLjoePWVhaBrPwIEGctQucEB/LbK2kcobv5s=
  - secure: ORYwz1WsgAqYxVTihesarRCSpaxWxjV0X5zapU3e/ijJRBpOtdyKzDRzBG3b+WF1hjPDo+vHPVFlvGeU7AxNjscTrBEEkrevZih/o4qvsUUw1tVVAJz+zo37Nqrto1iIpJERLT/EQuA9P/C2Q9ZowMfoMRKG6l98pHxufe9lB+ZxnuHM7PzpDI+5cS4q0ZU07EkzV1mA0XfEfcgKipRA8eUgmnaAP7TVdZ+48W4BUz+xwFj2NCZPmN7v4DRb2glESOY6gmfb5q4FsereAVE7iKtf8dEUwRnKrwmK/lBgG98VEloI5H1J9xBV08Bs0X949IdIDcCjCFCOG+SeCn/EDM/lgdR/fSvU3brC3ypQ3qz2AM/RkT4DJyiib8OcSsn2dAV9pHDnTG2HvcKlDMvYHT6QtbfnuveRAf+WTJNsbWSK7G9zGJ52xJsrRPkARW6iRO54ERi7hoeBhvO/x0Dnv4qno9caGUKZfbbHqJDQy2aYdheQh2zZcuZ/XVX3T9vNuHcFgw535LwUsQ5I9PpiU6awn2NGXLXpnFItnQgIKTeEtiu9HuvpMQJkuPD+cZSeqLIZn0zMgDpF9Hx+2Vqi7nqX2aJ3GNodBsFxjrubA3IrBiGI2ocR7k8qs4nnmiD9du60FD/OtCEyFWJ8cYdbGCP/ts3all27d2tE1RBLSaU=
  - secure: VFwh8+yyoPHzXQOFKLHmdsdGvNrbmbo0EorgwRY2BTURypgtB5jMSKObgA2nOFI5GUajCcNGPZsi/HJ2heZ0vkZRFGFQGmM7Ve5VO0Qeh6+kilnQQmONkHLob8kNOGEv70O8cv9gHZia/c+OnVi4+O6M69R9JVEv9PYzmLMfAKQ/kjiZ63UqPz8fTWSZYMIQp1o8lS3QdOJu6ysi/gDjEdEfuuNx9cFnauoJEEopinXK1XUZixQKueRWfsx8cC6iBO060bIQz3veclyUMNQFsWvX6+oWNmZh+9c5OgMwyZUEyuoV5doYOoWcn9OvHgKFIFxwNOeq/63cjRcrqj1WPo8RI0pMwMMr0ls13b8PyZkE3FvvbxPxeBWIjb+03Koss8hk/St83qh+fFp4OrAPaBbVMJv1wLXFdH9uwyOPSJc8KLSy17MN2avNJTHgIFX6BrLF1G7dK/7vTkIA2KsvixMu5oGrPCDFj7c4jh1nE9B9m9TqvjksrY8VXR/tlZybLnxedWmUlz5Ar6eQb8Uub2CCfzz/m9BqzDxvc4TiurPQYRvlGZwWDJ0IlIDzFi2iR3fYR4zURABeisM2bV0SXeSM9nSv/XQKhLbjcIs2hkJYMZUbq16Aj5sP82JL+a98CW6CEqd7LV10tnhCzd5PpsL/lBwwUCVf4XExr9QEHAM=
  - secure: A6IHsTlg8ocKoQ0M3SLkN2VNhFZPZ5MxBEnxOU11Y4RiOzGjBYyRYsb3HWdOynzbzYsXTyLZ/jZTkQp1AHE6xDhCpGNNUA10mYui/4Y80Axe8/sDMDKyYrpMzKkhWrLF15xVJB6TG8mdL3ZWuGyr9uOtv2eSLqST0RDFfk2ArOEO0i/2Nucuwqnerf8zAOV9YInVJkG1DTf7q3rVrwQnxqKng15hjIbGI9wTpXgvmAXIX2G1s5y4FHtyXUBPzSWjrYXxE1AbJeymDtkrDxouHprkKmYXRE7iBCJ/dX/B4wY/y21nJOk6Qm4POAlyL90a8g+iB6bwXYyfTKfHUmcOyFegoQOrLt+ng/Cuf5f8hLeCm+w/f3/KSCkfFXeMsYUOn2SckMDkly3WT15B4rfD6ryMMb91RmkzwwCfhqxQ9C2FQHIfRKrXJGbemI0tUMGifvHqZRsl3jtTEiWfMJaJ7uhnhbHxcIx9k3vQRjVrOJwM5TVe389eNA2guqaF/Tw31ww7Ni5qHBliOUCvvqiXIfPnwJHRrGlMPF4ZP5G9oZjQZyz9+jKw465Z4BXSSBKN+58Alcy8piSSGhMmcpwdUQECz3P4zhCRnQUSDVJxOqYR6IfMNeQiHbfLkPpt8VsJbXS4oAAevJG2ghNEkuN6eONfA1q5DDTqGHvNisNFtwk=
  - secure: lpSRkZvA8Tryh533yttiJCjir+eFvTVUXVd/77KUu9JFK5fEpxeDIEbM83ypqMjxks37WlBxGq2GvNcT/RtXHzzcK8UBk67c33WvZ+0I2oHdQ+R6fEoU+XVGulmAhDXfRKVIZmKhUahriEEAn6vRkVJiLsit6X0BwlzjkO23oA4I+XKg85MzX0sjquNdZuVRQOylzszA/0sZ9z2p+HGdtd/sRkRmk1+NH5FWr16L/lPDXFNi/rqzGReS7BVCh8cMKamAfC/dk5Bg3urFeqKGSx0JIYun3H28aUHr6UNcBQYp6IvwZeOx/nYHo40dVCDJsoQ1jmiHkhJNOI4BIihZ3uhGVVSEBBi3wkQGITklKeXd01KC9pcG312/ejSicLZJR2wN7wWaG++dZIrt5e0BaA3Vu5ZFqT9PtovcKZXlWc+nTHRPyTzvUBUNTOIKB9y0W7tPDRy9Ll9mlULGCFj+9hUL06Z280iWumoPXlSnvFbISe6YMZPBguoj2fSpxBoQxRSxPEpNVPI0oBarPiJKBAEL5+lPCzcvbFaQ9DfMiRgq6jkPSEhETLTwWbD2ry9RqrlUwHgdwXKFh9PAzPDumsxT9NINkxcreKtOEyp3KT7Gd0lEdXCVWzpNMmIVOE18XJu2hzYvzxw7QckNjFibyPE7T3onzKvuF3xUFnm6n/M=
  - secure: V34uysUGBWr4csTItG1/WX4k71HpjqhcZsrUFxHaNR1347ViEi6LU38ljjdEutv+rSQerzDSFOA0pJKdRfDF2EmqcvVayYa3+Q3UZ9T604VYDEK0FyW8deDAXX6bKrjUOXihGgnaFXGuk3+w7yIUEA5kxg2e4aDmsYcvnUVMgHR0koXx0vLDwOLphrgY8LFle9uCPXptV8fInEYJx/AvuqE3wGjUVT/qo5FA2sZpXv70c/gtubYEBdLh1nIgQUXY2vjQ/edG9/hvNt19hRa1SDFhhb4unConK+9DTDSJpaVuWOvG6qEM4/g5pWamGCBy3KfkYwi1iCSuFcRbMQE52B0bUxAAoh8QLGLQa0rfkttUgAoOak1/S3DVznko5HwEPQkSfBBbAtMQrcVtfwR6GEXzl3zRVNbCkRxwp9IDFdIqns0e5e2/Gn4fDD/w0rnMFrZULzqXgY+bR3bi6D3ajEy+aD7uMyZI/lhJljN7Sd/j2jRO+1nBqozRB12S4PBgu+hzU6yN+F74M0/qAlGO8isAGAX4N3KXWNDupXUrkdFFq574yvs1ESb78IRqz9DzbsuyoxhKWFhb90tdFKkVChX2v1PMJFqieRLoqxkA/65gXlEwIBVrh3HEXqEaqxOyPJ4BJ0gFzcTJ8vdiED6FxnAaQQ59klvq7mJx4T/VU6M=
  - secure: kJhst+apvAOFfSuz5w42A2IxB3jJx+ZDXVfVjQ1q3GDIwrKgIxVawRgJEpgd6/EgtKepAdVDxeNV1XyxvC2osCI1Qbmx6lZWEqo0UOcn0r5RuiutH6Q7hfJELqzdGoSallZhcEAEXMfTGZI38JUDSYod/W5XllLaFvncpzSS3ZupSXajdkQGddhbMHqL0ZskmqmouGDmlH7uWdaJvQs/pa8MpXv3NFP9HKJFyRis8X19V9gnl59HPvflwb0re5Y+Por+QUqqL/sdoH9+wSGG4yDkFze6CUNAfETuYh+pryZDNypp3na/HEg3mQ21M/zO/DRjYOVlu9HCW94OD0x6AUn+11uBmZNmFAXuyd+8tu5N0saB0hsCN8hSsE6IlnyGdit49gyM7bBUMVO9z2fPpkzEloKZXnzQAbqKwxbngC4Y6KFNMDu/MuVqxJ84DDvmPbAh5tUA1MemUjc3D8VXN2WNhqfAMw1iu8q/9Uq8Roz6oqR3kw0A+1gUApcBokXHBnd0n2r5/4Td4II5FcPcwZaNTZy5EbcxUxB03Tdwu3CP7uvFTkhkpPRmXYaaosv8BAmxB5V+GoImk03DHY8n6/qxuEuL5YVijxP+JwTV3ODBZcTRsHmB/hIMrFRh2m+uuLFQ12qZP/elTXetukg8aiQyx6TbvVA/SHlC3GMNoGM=
  - secure: pY0R42boXlLyAmVM0f3jKLe6FODs/M0qA2QQXpz2Zfl5aFwirFFfcwrKsOMcOBlq71hYRihuVX7TmkhPFAkcewMckFC23Qj1p+62q4jpDvYy+z2ykRpNUvTcRFtxMxyVqN37IPjiebIY0cmK8ocUujt0Qthhn55Q4CgAHUK8Mql8ADdzWOP6wKbASStFOuKanj1qGiYToIVmZw9Y32ucdVdq6RuLENiKicfodKIuxpqYcNn8eRUgIwQRD1tQIiqcniN+/B9IOeoVTEPgTdr98FfA8bn44ZUaKoLZ8SRMuUmlL+FUsD8W0dIrcVwFAJjPsZNoF0Dfu0yVNDla1jYGMdUKfhXzsT/a1lV5YQaqdrBcrtbpYHQ72dRb6+tWYowPCpQwXqWxDses8MBQm2WnQbeCkAjnlbHkS/miPaPSfEKrhNgT3ZW5wSTQ8rGtQPd1lO1xsxtnrm2LODlON0KubKXSdiyjw7COCS3WbkPiID3eqOu3mtEznjPaMGnCSYU/TMFWFOmj2A8SEh4CfrnK8dUTTvv7Jv9P36PZv4LIIn3wqnw75gxOzYKaJy6oLpeVq+eA9imbWqvdnxnRJ79GDHOsqd4E8Yrsv/RhIuSh3ERL2hWVk2k70V24n5n3Z5vWbTn1TtjmDCaIKNC9x7YICn4xBAmv664ZMYbQ9IG81Rk=
before_script:
- sudo iptables -L DOCKER || ( echo "DOCKER iptables chain missing" ; sudo iptables
  -N DOCKER )
- eval "$(/opt/chefdk/bin/chef shell-init bash)"
- chef gem install kitchen-ec2
- chef gem install kitchen-docker
- chef gem install kitchen-transport-rsync
- "/opt/chefdk/bin/chef exec rake tests"
script:
- KITCHEN_LOCAL_YAML=.kitchen.yml
- travis_wait 30 /opt/chefdk/embedded/bin/kitchen verify ${INSTANCE}
after_script:
- "/opt/chefdk/embedded/bin/kitchen destroy ${INSTANCE}"
notifications:
  email:
    on_success: change
    on_failure: always
  slack:
    secure: Y92IfCEpjjufjM09p5obRelhnCuYZ72HJ9fVzLF6v+tNfKBBiBCwzEcQ/Ba5GQNLjvOT/fX/YweiOSAPisVK2CrF14IzqPfMK1kNrEFAQTMNDvx2Ojvpi2dQJxW1cOjUQM17Nswj6V8FIyUymmI1uc+PjP2mBSboP9LUDrjDw6+seUMGs0AwMan1MYwGsLs6Ec/BTDMvkY1QIgl/zrG2NNDznXA6EQqoz6rdLelmEs5FhbNXFTJ0kUqST8Sfgmw9+HGFs9D1FIfeuvfApMsT0f48EAbSPSAyv2eILn8aG+V08W+QBikiy+PvhBPireq0ACAqXQefgYANdju2kRVjJPunJoG6Ied7WbQXNPkqArvsdCs7UuU37UEZyqQjVmB9hvxZDwqgpL31Ama6ryjD/LiRikBNW/NwyHgJ2JSpqRjoZczbd39ecfSonvfB2G0d2cC+HLq1j1lcus3Tt9tg+DiHAgrW5tZroCWbEfc1YUuO9EWVkwJmZitab7IUakxk6xcZoXt3yd6jk1Ctd9pSQ0QcNh/uBiZEuyc2o54QtC5A9jP1pN323qp9KnjrOKgaHKXF4bzQiU9OMiBOH4ipEFoaYCfe17HYaBRxFFa+oJI9Rkwg2pidrSlQxHzK4mmggnG5BS5jSDqjQLAjVaZOGt9+hVFJ9M+WgMq8547LpY4=
before_install:
- mkdir ~/chef-repo
- mkdir ~/.chef
- openssl aes-256-cbc -K $encrypted_0ef5a9f6c632_key -iv $encrypted_0ef5a9f6c632_iv
  -in eagletravis-ci.enc -out ~/.ssh/eagletravis-ci -d
- openssl aes-256-cbc -K $encrypted_0ef5a9f6c632_key -iv $encrypted_0ef5a9f6c632_iv
  -in encrypted_data_bag_secret.enc -out ~/.chef/encrypted_data_bag_secret -d
- openssl aes-256-cbc -K $encrypted_0ef5a9f6c632_key -iv $encrypted_0ef5a9f6c632_iv
  -in databags_and_roles.tar.enc -out ~/chef-repo/databags_and_roles.tar -d
- eval "$(ssh-agent -s)"
- chmod 600 ~/.ssh/$AWS_SSH_KEY_ID
- ssh-add ~/.ssh/$AWS_SSH_KEY_ID
- tar -xvf ~/chef-repo/databags_and_roles.tar -C /home/travis/build/
after_success:
- docker login -u $DOCKER_USER -p $DOCKER_PASS
- docker commit mapseq-runnable eaglegenomics/mapseq:auto-build 
- docker push eaglegenomics/mapseq:auto-build
